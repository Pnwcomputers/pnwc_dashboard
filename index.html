<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNW Computers Job Tracker Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body>

<div id="app" class="min-h-screen p-4 sm:p-8">
    <!-- Header -->
    <header class="text-center mb-8">
        <h1 class="text-4xl font-extrabold text-blue-900 mb-2">Pacific NW Computers Job Tracker</h1>
        <p class="text-gray-600">Daily Dashboard & Job Check-In System</p>
    </header>

    <!-- Tab Navigation -->
    <nav class="flex justify-center space-x-2 sm:space-x-4 mb-8 border-b-2 border-gray-200">
        <button id="dashboard-tab" onclick="showTab('dashboard')" class="py-2 px-4 text-sm sm:text-lg font-medium text-blue-700 border-b-4 border-blue-700 transition-colors duration-300">
            Dashboard
        </button>
        <button id="checkin-tab" onclick="showTab('checkin')" class="py-2 px-4 text-sm sm:text-lg font-medium text-gray-500 hover:text-blue-700 hover:border-blue-700 transition-colors duration-300">
            New Job Check-In
        </button>
    </nav>

    <!-- Main Content Area -->
    <div class="max-w-6xl mx-auto">
        
        <!-- Tab 1: Dashboard View -->
        <div id="dashboard-view" class="tab-content space-y-8">
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">Today's Focus</h2>

            <!-- Onsite Appointments/Today Todo List (Dynamically Populated) -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-blue-100">
                <h3 class="text-xl font-semibold text-blue-800 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Onsite Schedule & Upcoming Tasks
                </h3>
                <div id="schedule-list" class="space-y-3">
                    <!-- Schedule items will be inserted here by JavaScript -->
                    <p id="schedule-loading" class="text-gray-500 italic">Loading today's schedule...</p>
                    <p id="schedule-error" class="text-red-500 font-semibold hidden">Error loading schedule. Check Apps Script deployment.</p>
                </div>
            </div>
            
            <!-- General Job Status Overview (Mock/Placeholder until advanced read is added) -->
            <div class="bg-white p-6 rounded-xl shadow-lg border border-indigo-100">
                <h3 class="text-xl font-semibold text-indigo-800 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Current Shop Job Overview (Mock Data)
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium text-gray-700">Awaiting Customer Approval:</span>
                        <span class="text-orange-500 font-bold">4 Jobs</span>
                    </div>
                     <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium text-gray-700">Awaiting Parts (Vendor Side):</span>
                        <span class="text-yellow-600 font-bold">7 Jobs</span>
                    </div>
                    <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium text-gray-700">Ready for Pickup/Delivery:</span>
                        <span class="text-green-600 font-bold">2 Jobs</span>
                    </div>
                </div>
            </div>

        </div>

        <!-- Tab 2: New Job Check-In Form -->
        <div id="checkin-view" class="tab-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">New Job Check-In Form</h2>

            <div id="message-box" class="hidden p-4 mb-4 rounded-lg text-center font-semibold transition-all duration-500"></div>

            <form id="job-checkin-form" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 space-y-6">
                
                <!-- Client Info -->
                <fieldset class="border border-gray-300 p-4 rounded-lg">
                    <legend class="text-lg font-semibold text-gray-700 px-2">Client & Job ID</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="jobId" class="block text-sm font-medium text-gray-700">Job ID (e.g., WO-0001)</label>
                            <input type="text" id="jobId" name="jobId" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="clientName" class="block text-sm font-medium text-gray-700">Client Name</label>
                            <input type="text" id="clientName" name="clientName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="clientEmail" class="block text-sm font-medium text-gray-700">Client Email (For Follow-Up)</label>
                            <input type="email" id="clientEmail" name="clientEmail" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="clientPhone" class="block text-sm font-medium text-gray-700">Client Phone</label>
                            <input type="tel" id="clientPhone" name="clientPhone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </fieldset>

                <!-- Job Details -->
                <fieldset class="border border-gray-300 p-4 rounded-lg">
                    <legend class="text-lg font-semibold text-gray-700 px-2">Service Details</legend>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="serviceType" class="block text-sm font-medium text-gray-700">Service Type</label>
                            <select id="serviceType" name="serviceType" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border bg-white focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select Type</option>
                                <option value="In-Shop">In-Shop</option>
                                <option value="Onsite">Onsite</option>
                                <option value="Remote">Remote</option>
                                <option value="Pick-up/Delivery">Pick-up/Delivery</option>
                            </select>
                        </div>
                        <div>
                            <label for="dueDate" class="block text-sm font-medium text-gray-700">Promised Due Date</label>
                            <input type="date" id="dueDate" name="dueDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="currentStatus" class="block text-sm font-medium text-gray-700">Initial Status</label>
                            <select id="currentStatus" name="currentStatus" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border bg-white focus:ring-blue-500 focus:border-blue-500">
                                <option value="1. Checked In: Diagnostics">1. Checked In: Diagnostics</option>
                                <option value="4. In Progress: Repair/Install">4. In Progress: Repair/Install (Immediate Start)</option>
                                <option value="2. Awaiting Customer Approval">2. Awaiting Customer Approval</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label for="systemMake" class="block text-sm font-medium text-gray-700">System Make/Model (e.g., Dell XPS 13)</label>
                        <input type="text" id="systemMake" name="systemMake" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div class="mt-4">
                        <label for="initialRequest" class="block text-sm font-medium text-gray-700">Customer's Initial Request/Problem</label>
                        <textarea id="initialRequest" name="initialRequest" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                </fieldset>

                <!-- Submit Button -->
                <button type="submit" id="submit-button" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-sm text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-300">
                    Log Job & Check In System
                </button>
            </form>
        </div>

    </div>
</div>

<script>
    // CRITICAL: Replace this placeholder with the Web App URL generated from your Google Apps Script deployment (see setup guide)
    const WEB_APP_URL = https://script.google.com/macros/s/AKfycbz_69SzCgirUDv1tmrK5kX-bizQ12guTtRUFcAq_vzSAKvYmgWgCPhqo_l2_zp5s0uu2A/exec; 

    // --- Tab Switching Logic ---
    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => {
            el.classList.add('hidden');
        });
        document.querySelectorAll('button[id$="-tab"]').forEach(el => {
            el.classList.remove('text-blue-700', 'border-blue-700');
            el.classList.add('text-gray-500', 'hover:text-blue-700', 'hover:border-blue-700');
            el.classList.remove('border-b-4');
            el.classList.add('border-b-2');
        });

        document.getElementById(`${tabName}-view`).classList.remove('hidden');
        const activeTab = document.getElementById(`${tabName}-tab`);
        activeTab.classList.remove('text-gray-500', 'hover:text-blue-700', 'hover:border-blue-700');
        activeTab.classList.add('text-blue-700', 'border-blue-700', 'border-b-4');
        activeTab.classList.remove('border-b-2');
        
        // Load data whenever the dashboard is viewed
        if (tabName === 'dashboard') {
            fetchScheduleData();
        }
    }

    // --- Message Box Utility ---
    function showMessage(type, message) {
        const box = document.getElementById('message-box');
        box.textContent = message;
        box.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
        
        if (type === 'success') {
            box.classList.add('bg-green-100', 'text-green-800');
        } else if (type === 'error') {
            box.classList.add('bg-red-100', 'text-red-800');
        }

        // Hide after 5 seconds
        setTimeout(() => {
            box.classList.add('hidden');
        }, 5000);
    }

    // --- Data Submission (POST) Logic ---
    document.getElementById('job-checkin-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        
        const button = document.getElementById('submit-button');
        button.disabled = true;
        button.textContent = 'Submitting...';

        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());

        if (WEB_APP_URL.includes("YOUR_APPS_SCRIPT_WEB_APP_URL_HERE")) {
            showMessage('error', "ERROR: Web App URL is not configured. Please update the 'WEB_APP_URL' constant in the code.");
            button.disabled = false;
            button.textContent = 'Log Job & Check In System';
            return;
        }

        try {
            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'text/plain', // Must be text/plain for Google Apps Script to read JSON correctly
                },
                body: JSON.stringify(data)
            });

            // Apps Script response is often wrapped in a text response, we must parse it manually
            const textResponse = await response.text();
            const result = JSON.parse(textResponse);

            if (result.result === 'success') {
                showMessage('success', `Success! Job ${data.jobId} logged in row ${result.row_count}.`);
                event.target.reset();
                // Switch back to dashboard after successful submission
                showTab('dashboard'); 
            } else {
                showMessage('error', `Error logging job: ${result.message}`);
            }

        } catch (error) {
            console.error('Network or Parse Error:', error);
            showMessage('error', `Network Error: Could not connect to the system. ${error.message}`);
        } finally {
            button.disabled = false;
            button.textContent = 'Log Job & Check In System';
        }
    });

    // --- Data Retrieval (GET) Logic for Dashboard ---
    async function fetchScheduleData() {
        const list = document.getElementById('schedule-list');
        const loading = document.getElementById('schedule-loading');
        const errorMsg = document.getElementById('schedule-error');
        
        list.innerHTML = '';
        loading.classList.remove('hidden');
        errorMsg.classList.add('hidden');

        if (WEB_APP_URL.includes(https://script.google.com/macros/s/AKfycbyYtl6oDNkGC1NDYj3qu1cZGQFKWVwjaJH4cynWcHhbZ4Panqzu3dWm0iLZKPf-s8r0WA/exec)) {
            errorMsg.textContent = "ERROR: Web App URL not configured. Schedule cannot load.";
            errorMsg.classList.remove('hidden');
            loading.classList.add('hidden');
            return;
        }

        try {
            const response = await fetch(WEB_APP_URL, {
                method: 'GET',
                mode: 'cors'
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // The response from doGet is raw JSON content
            const data = await response.json(); 

            loading.classList.add('hidden');

            if (data.length === 0) {
                list.innerHTML = '<p class="text-gray-500 italic">No onsite appointments scheduled for the next 14 days.</p>';
                return;
            }

            // Filter for events that are happening today (simple date comparison)
            const today = new Date().toLocaleDateString();
            const todayEvents = data.filter(item => {
                // Event Date is the first column in the sheet, e.g., "10/27/2025"
                return new Date(item.Event_Date).toLocaleDateString() === today;
            });
            
            const upcomingEvents = data.filter(item => {
                // Check if the event is NOT today and is in the future
                const eventDate = new Date(item.Event_Date);
                return eventDate > new Date() && eventDate.toLocaleDateString() !== today;
            });


            // --- Render Today's Events ---
            if (todayEvents.length > 0) {
                list.innerHTML += '<h4 class="text-lg font-bold text-gray-800 mb-2 mt-4">Today, ' + today + '</h4>';
                todayEvents.forEach(item => {
                    list.innerHTML += createScheduleItem(item, 'bg-blue-50 border-blue-200');
                });
            } else {
                list.innerHTML += '<h4 class="text-lg font-bold text-gray-800 mb-2 mt-4">Today:</h4><p class="text-gray-500 italic">No appointments scheduled for today.</p>';
            }

            // --- Render Upcoming Events ---
            if (upcomingEvents.length > 0) {
                list.innerHTML += '<h4 class="text-lg font-bold text-gray-800 border-t pt-3 mt-4">Upcoming Schedule</h4>';
                 upcomingEvents.forEach(item => {
                    list.innerHTML += createScheduleItem(item, 'bg-gray-50 border-gray-200');
                });
            }


        } catch (error) {
            console.error('Error fetching schedule:', error);
            loading.classList.add('hidden');
            errorMsg.classList.remove('hidden');
            errorMsg.textContent = `Error: Failed to fetch schedule. Check console for details.`;
        }
    }

    function createScheduleItem(item, bgColor) {
        return `
            <div class="p-3 ${bgColor} rounded-lg shadow-sm flex flex-col sm:flex-row justify-between">
                <div class="sm:w-1/4 font-semibold text-blue-700">${item.Time_Start/End}</div>
                <div class="sm:w-1/4 font-semibold text-gray-800">${item.Client_Name} (${item.Job_ID})</div>
                <div class="sm:w-1/2 text-sm text-gray-600 truncate">${item.Location/Address}</div>
            </div>
        `;
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        showTab('dashboard'); // Start on the dashboard view
    });
</script>
</body>
</html>
